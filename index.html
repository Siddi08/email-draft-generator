<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Draft Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9fafb;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState } = React;

        function App() {
          const [brainDump, setBrainDump] = useState('');
          const [formData, setFormData] = useState({
            recipient: '',
            context: '',
            specificRequest: '',
            deadline: '',
            tone: 'formal'
          });
          const [drafts, setDrafts] = useState(null);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');

          const handleBrainDump = async () => {
            if (!brainDump.trim()) return;
            
            setLoading(true);
            setError('');
            
            try {
              const res = await fetch('/.netlify/functions/process-brain-dump', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brainDump })
              });
              
              if (!res.ok) throw new Error('Failed');
              
              const data = await res.json();
              setFormData({
                recipient: data.recipient || '',
                context: data.context || '',
                specificRequest: data.specificRequest || '',
                deadline: data.deadline || '',
                tone: data.suggestedTone || 'formal'
              });
              setBrainDump('');
            } catch (err) {
              setError('Brain dump failed: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const handleGenerate = async () => {
            if (!formData.recipient || !formData.context) {
              setError('Need recipient and context');
              return;
            }
            
            setLoading(true);
            setError('');
            setDrafts(null);
            
            try {
              const res = await fetch('/.netlify/functions/generate-emails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  emailType: 'follow-up',
                  ...formData
                })
              });
              
              if (!res.ok) throw new Error('Failed');
              
              const data = await res.json();
              console.log('Got drafts:', data);
              setDrafts(data);
            } catch (err) {
              setError('Generation failed: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const copyText = async (text) => {
            try {
              await navigator.clipboard.writeText(text);
              alert('Copied!');
            } catch (err) {
              console.error('Copy failed:', err);
            }
          };

          return (
            <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
              <h1 style={{ marginBottom: '30px' }}>Email Draft Generator</h1>

              {/* Brain Dump */}
              <div style={{ marginBottom: '30px', padding: '20px', background: '#e0f2fe', borderRadius: '8px' }}>
                <h2 style={{ fontSize: '18px', marginBottom: '10px' }}>üí≠ Brain Dump (Optional)</h2>
                <textarea
                  value={brainDump}
                  onChange={(e) => setBrainDump(e.target.value)}
                  placeholder="Dump all your thoughts here..."
                  rows={5}
                  style={{ width: '100%', padding: '10px', fontSize: '15px', borderRadius: '6px', border: '1px solid #0ea5e9' }}
                />
                <button
                  onClick={handleBrainDump}
                  disabled={loading || !brainDump.trim()}
                  style={{
                    marginTop: '10px',
                    padding: '10px 20px',
                    background: loading ? '#93c5fd' : '#0ea5e9',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: loading ? 'not-allowed' : 'pointer'
                  }}
                >
                  {loading ? 'Processing...' : 'Extract & Fill Form'}
                </button>
              </div>

              {/* Form */}
              <div style={{ marginBottom: '30px' }}>
                <div style={{ marginBottom: '15px' }}>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Recipient *</label>
                  <input
                    value={formData.recipient}
                    onChange={(e) => setFormData({...formData, recipient: e.target.value})}
                    placeholder="Who are you emailing?"
                    style={{ width: '100%', padding: '10px', fontSize: '15px', borderRadius: '6px', border: '1px solid #ddd' }}
                  />
                </div>

                <div style={{ marginBottom: '15px' }}>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Context *</label>
                  <textarea
                    value={formData.context}
                    onChange={(e) => setFormData({...formData, context: e.target.value})}
                    placeholder="What's the situation?"
                    rows={3}
                    style={{ width: '100%', padding: '10px', fontSize: '15px', borderRadius: '6px', border: '1px solid #ddd' }}
                  />
                </div>

                <div style={{ marginBottom: '15px' }}>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>What do you need?</label>
                  <input
                    value={formData.specificRequest}
                    onChange={(e) => setFormData({...formData, specificRequest: e.target.value})}
                    placeholder="Your request..."
                    style={{ width: '100%', padding: '10px', fontSize: '15px', borderRadius: '6px', border: '1px solid #ddd' }}
                  />
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Deadline</label>
                  <input
                    value={formData.deadline}
                    onChange={(e) => setFormData({...formData, deadline: e.target.value})}
                    placeholder="ASAP, by Friday, etc."
                    style={{ width: '100%', padding: '10px', fontSize: '15px', borderRadius: '6px', border: '1px solid #ddd' }}
                  />
                </div>

                {error && (
                  <div style={{ padding: '10px', background: '#fee2e2', color: '#991b1b', borderRadius: '6px', marginBottom: '15px' }}>
                    ‚ö†Ô∏è {error}
                  </div>
                )}

                <button
                  onClick={handleGenerate}
                  disabled={loading}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: loading ? '#93c5fd' : '#2563eb',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    fontSize: '16px',
                    fontWeight: '500',
                    cursor: loading ? 'not-allowed' : 'pointer'
                  }}
                >
                  {loading ? 'Generating...' : 'Generate Email Drafts'}
                </button>
              </div>

              {/* Results */}
              {drafts && (
                <div>
                  <h2 style={{ marginBottom: '20px' }}>Your Email Drafts</h2>
                  {['friendly', 'formal', 'direct'].map((tone) => {
                    const draft = drafts[tone];
                    console.log('Rendering tone:', tone);
                    console.log('Draft object:', draft);
                    console.log('Draft.subject type:', typeof draft?.subject);
                    console.log('Draft.subject value:', draft?.subject);
                    console.log('Draft.body type:', typeof draft?.body);
                    
                    if (!draft) return null;
                    
                    // Force everything to be a string
                    const subject = String(draft.subject || 'No subject');
                    const body = String(draft.body || 'No body');
                    
                    console.log('After String conversion - subject:', subject);
                    console.log('After String conversion - body:', body);
                    
                    return (
                      <div key={tone} style={{ marginBottom: '20px', padding: '20px', background: 'white', borderRadius: '8px', border: '1px solid #ddd' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '15px' }}>
                          <h3 style={{ textTransform: 'capitalize' }}>{tone} Version</h3>
                          <button
                            onClick={() => copyText(subject + '\n\n' + body)}
                            style={{
                              padding: '8px 15px',
                              background: '#f3f4f6',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer'
                            }}
                          >
                            üìã Copy
                          </button>
                        </div>
                        
                        <div style={{ marginBottom: '10px' }}>
                          <strong style={{ color: '#666', fontSize: '13px' }}>Subject:</strong>
                          <div style={{ marginTop: '5px' }}>{subject}</div>
                        </div>
                        
                        <div>
                          <strong style={{ color: '#666', fontSize: '13px' }}>Body:</strong>
                          <div style={{ marginTop: '5px', padding: '15px', background: '#f9fafb', borderRadius: '6px', whiteSpace: 'pre-wrap' }}>
                            {body}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
